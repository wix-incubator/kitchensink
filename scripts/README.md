# Package Version Management Scripts

This directory contains a comprehensive suite of scripts for managing package versions across projects, from analyzing conflicts to synchronizing exact versions between multiple codebases.

## 📋 Available Scripts

### 1. Extract Resolutions (Conflict Resolution)

**Purpose**: Find and resolve version conflicts in your dependency tree

```bash
npm run extract-resolutions
npm run extract-resolutions:advanced
```

**What it does**:

- Analyzes `package-lock.json` for packages with multiple versions
- Suggests resolutions for version conflicts
- Generates yarn resolutions and npm overrides
- Provides detailed conflict analysis with severity assessment

### 2. Extract All Versions (Complete Version Manifest)

**Purpose**: Extract every single package version for cross-project synchronization

```bash
npm run extract-all-versions
npm run sync-versions
```

**What it does**:

- Extracts ALL package versions from `package-lock.json` (not just conflicts)
- Creates complete version manifests for project synchronization
- Supports filtering (direct deps, dev deps, production only)
- Multiple output formats (resolutions, overrides, detailed manifest)

### 3. Apply Versions (Cross-Project Synchronization)

**Purpose**: Apply version manifests to other projects for exact version matching

```bash
npm run apply-all-versions <manifest-file> <target-project>
```

**What it does**:

- Takes a version manifest and applies ALL versions to another project
- Ensures identical package versions across multiple projects
- Automatic package manager detection
- Safe application with backups and dry-run mode

## 🚀 Quick Start

### Scenario 1: Fix Version Conflicts

```bash
# Analyze conflicts only
npm run extract-resolutions

# Advanced analysis with severity assessment
npm run extract-resolutions:advanced -- --major-only
```

### Scenario 2: Synchronize All Versions Across Projects

```bash
# 1. Extract complete version manifest from source project
npm run extract-all-versions

# 2. Apply to target project(s)
npm run apply-all-versions ./version-manifest.json ../other-project
```

### Scenario 3: Direct Dependencies Only

```bash
# Extract only direct dependencies
npm run extract-all-versions -- --direct-only --format=detailed

# Apply only direct dependency versions
npm run apply-all-versions ./version-manifest.json ../other-project --direct-only
```

## 📊 Script Comparison

| Script                         | Use Case                   | Output                        | Best For                      |
| ------------------------------ | -------------------------- | ----------------------------- | ----------------------------- |
| `extract-resolutions`          | Fix conflicts              | Conflicting packages only     | Resolving version conflicts   |
| `extract-resolutions:advanced` | Advanced conflict analysis | Conflicts with severity/stats | Detailed conflict assessment  |
| `extract-all-versions`         | Complete sync              | ALL package versions          | Cross-project synchronization |
| `apply-all-versions`           | Version sync               | Applies versions to project   | Ensuring identical versions   |

## 🛠️ Advanced Usage

### Extract All Versions Options

```bash
# Direct dependencies only
npm run extract-all-versions -- --direct-only

# Development dependencies only
npm run extract-all-versions -- --dev-only

# Production dependencies only
npm run extract-all-versions -- --prod-only

# Different output formats
npm run extract-all-versions -- --format=overrides  # NPM format
npm run extract-all-versions -- --format=detailed   # Full manifest
npm run extract-all-versions -- --format=manifest   # Shareable format

# Group by npm scope
npm run extract-all-versions -- --group-by-scope

# Verbose output with package details
npm run extract-all-versions -- --verbose
```

### Apply Versions Options

```bash
# Dry run (preview changes)
npm run apply-all-versions ./manifest.json ../project --dry-run

# Force NPM overrides format
npm run apply-all-versions ./manifest.json ../project --npm

# Clean install after applying
npm run apply-all-versions ./manifest.json ../project --clean --install

# Direct dependencies only
npm run apply-all-versions ./manifest.json ../project --direct-only

# Skip missing packages
npm run apply-all-versions ./manifest.json ../project --skip-missing
```

## 📁 Output Files

| File                        | Generated By                   | Contains                                  |
| --------------------------- | ------------------------------ | ----------------------------------------- |
| `resolutions.json`          | `extract-resolutions`          | Conflict analysis + suggested resolutions |
| `resolutions-advanced.json` | `extract-resolutions:advanced` | Advanced conflict analysis with metadata  |
| `version-manifest.json`     | `extract-all-versions`         | Complete version manifest                 |

## 🎯 Common Workflows

### Workflow 1: Setup Version Synchronization

```bash
# 1. In source project (the one with desired versions)
npm run extract-all-versions -- --format=manifest

# 2. In each target project
npm run apply-all-versions ./version-manifest.json . --clean --install
```

### Workflow 2: Fix Critical Conflicts Only

```bash
# 1. Find major version conflicts
npm run extract-resolutions:advanced -- --major-only

# 2. Apply critical resolutions only
node scripts/apply-resolutions.js --critical-only
```

### Workflow 3: Monorepo Version Consistency

```bash
# 1. From main package, extract all versions
npm run extract-all-versions -- --format=detailed

# 2. Apply to each workspace
for dir in packages/*/; do
  npm run apply-all-versions ./version-manifest.json "$dir" --direct-only
done
```

## 🔧 Integration Examples

### For Yarn Projects

```json
{
  "resolutions": {
    "@radix-ui/react-accordion": "1.2.11",
    "react": "18.3.1",
    "typescript": "5.8.3"
  }
}
```

### For NPM Projects

```json
{
  "overrides": {
    "@radix-ui/react-accordion": "1.2.11",
    "react": "18.3.1",
    "typescript": "5.8.3"
  }
}
```

### For PNPM Projects

```json
{
  "pnpm": {
    "overrides": {
      "@radix-ui/react-accordion": "1.2.11",
      "react": "18.3.1",
      "typescript": "5.8.3"
    }
  }
}
```

## ⚠️ Best Practices

### Before Applying Versions

1. **Create backups** - Scripts create automatic backups, but verify
2. **Test compatibility** - Ensure version changes don't break functionality
3. **Review changes** - Use `--dry-run` to preview modifications
4. **Gradual rollout** - Apply to test environments first

### Version Synchronization Strategy

1. **Establish source of truth** - One project defines canonical versions
2. **Regular synchronization** - Schedule periodic version sync across projects
3. **CI/CD integration** - Automate version checking in build pipelines
4. **Document decisions** - Keep track of why specific versions are locked

### Conflict Resolution Strategy

1. **Start with major conflicts** - Use `--major-only` flag
2. **Security first** - Prioritize packages with known vulnerabilities
3. **Test incrementally** - Apply resolutions in small batches
4. **Monitor bundle size** - Check impact on build output

## 🔍 Troubleshooting

### Common Issues

**Issue**: "Version manifest not found"

```bash
# Solution: Generate manifest first
npm run extract-all-versions
```

**Issue**: "Conflicts with existing resolutions"

```bash
# Solution: Use force flag or review conflicts
npm run apply-all-versions ./manifest.json . --force
```

**Issue**: "Package manager auto-detection failed"

```bash
# Solution: Specify explicitly
npm run apply-all-versions ./manifest.json . --npm
# or
npm run apply-all-versions ./manifest.json . --yarn
```

### Getting Help

```bash
# Show help for any script
node scripts/extract-all-versions.js --help
node scripts/apply-all-versions.js --help
node scripts/extract-resolutions-advanced.js --help
```

## 🎯 Use Cases

- **Cross-project version consistency** - Ensure all projects use identical dependency versions
- **Monorepo management** - Synchronize versions across workspace packages
- **CI/CD optimization** - Reduce build times by eliminating duplicate packages
- **Security compliance** - Enforce specific versions for security requirements
- **Dependency auditing** - Generate complete inventory of all package versions
- **Migration assistance** - Help migrate projects to newer dependency versions

## 📋 Legacy Conflict Resolution

The original `extract-resolutions.js` script focuses specifically on finding and resolving version conflicts:

### Features

- 🔍 **Analyzes package-lock.json** - Scans your lockfile for version conflicts
- 📊 **Detailed reporting** - Shows which packages have multiple versions
- 🎯 **Smart resolution suggestions** - Recommends the latest version for each conflict
- 📋 **Multiple output formats** - Generates both yarn resolutions and npm overrides
- 💾 **JSON export** - Saves detailed analysis to a JSON file

### Sample Output

```
🔍 Analyzing package-lock.json...
📁 File: ./package-lock.json
📊 Lockfile version: 3

📋 Analysis Results:
📦 Total unique packages: 1032
🔄 Packages with multiple versions: 68

🚨 Packages with version conflicts:
  📌 zod:
     Versions: 3.22.3, 3.25.76, 4.0.14
     Suggested resolution: 4.0.14
     Found in: 5 locations
```

### Understanding the Results

- **Multiple versions** - Packages that exist in different versions across your dependency tree
- **Suggested resolution** - The latest version found (you may want to verify compatibility)
- **Found in X locations** - How many places in the dependency tree have this package

### Common Use Cases

- **Reducing bundle size** - Eliminate duplicate packages
- **Security updates** - Force newer versions with security fixes
- **Compatibility fixes** - Resolve version conflicts between dependencies
- **Development optimization** - Faster installs with fewer duplicate packages
