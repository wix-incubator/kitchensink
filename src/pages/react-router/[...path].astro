---
export const prerender = false;
import BaseLayout from '../../layouts/BaseLayout.astro';
import ReactRouterApp, {
  routes,
} from '../../react-pages/react-router/[...path]';
import '../../styles/theme-wix-vibe-config.css';
import '@wix/wix-vibe-plugins/plugins-vars.css';
import { createStaticHandler } from 'react-router';
import { SEO } from '@wix/seo/components';
import { loadSEOTagsServiceConfig } from '@wix/seo/services';

const basename = '/react-router';
const handler = createStaticHandler(routes, { basename });
const context = await handler.query(Astro.request);

// Let redirects/errors bubble straight out
if (context instanceof Response) {
  return context;
}

// Extract SEO config from the matched route's loader data
// React Router's context.loaderData contains the data from all matched routes
// We need to find the deepest (most specific) route that has seoTagsServiceConfig
let seoTagsServiceConfig;

// Check if we have matches and loaderData
if (context.matches && context.loaderData) {
  // Iterate through matches in reverse order (most specific route first)
  for (let i = context.matches.length - 1; i >= 0; i--) {
    const match = context.matches[i];
    const loaderData = context.loaderData[match.route.id];
    
    if (loaderData && typeof loaderData === 'object' && 'seoTagsServiceConfig' in loaderData) {
      seoTagsServiceConfig = loaderData.seoTagsServiceConfig;
      break;
    }
  }
}

// Fallback to default SEO config if no route provided one
if (!seoTagsServiceConfig) {
  seoTagsServiceConfig = await loadSEOTagsServiceConfig({
    pageUrl: Astro.url.href,
    itemData: {
      pageName: 'Store',
    },
  });
}
---

<BaseLayout useClientRouter={false}>
  <SEO.Tags seoTagsServiceConfig={seoTagsServiceConfig} slot="seo-tags" />
  <div class="mx-auto max-w-7xl react-router" id="root">
    <ReactRouterApp
      client:load
      context={context}
      basename={basename}
      slot="body"
    />
  </div>
</BaseLayout>
