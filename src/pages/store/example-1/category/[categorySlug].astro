---
import { loadCurrentCartServiceConfig } from '@wix/headless-ecom/services';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import StoreCollectionPage from '../../../../react-pages/store/example-1';
import { loadCategoriesListServiceConfig } from '../categories-list';
import { loadCategoryServiceConfig } from '../category';
import { buildSearchOptionsFromUrl } from '../parseSearchOptionsFromUrl';
import { loadProductsListServiceConfig } from '../products-list';

const { categorySlug } = Astro.params;

if (!categorySlug) {
  throw new Error('Category slug is required');
}

const categoryLoadResult = await loadCategoryServiceConfig(categorySlug);

if (categoryLoadResult.type === 'not-found') {
  return Astro.rewrite('/404');
}

const category = categoryLoadResult.config.category;

const searchOptions = buildSearchOptionsFromUrl(Astro.url.href, {
  filter: {
    'allCategoriesInfo.categories': {
      $matchItems: [{ _id: category._id! }],
    },
  },
  cursorPaging: {
    limit: 10,
  },
});

const [productsListConfig, categoriesListConfig, currentCartServiceConfig] =
  await Promise.all([
    loadProductsListServiceConfig(searchOptions),
    loadCategoriesListServiceConfig(),
    loadCurrentCartServiceConfig(),
  ]);
---

<BaseLayout>
  <StoreCollectionPage
    client:load
    slug={categorySlug}
    productsListConfig={productsListConfig}
    categoriesListConfig={categoriesListConfig}
    currentCartServiceConfig={currentCartServiceConfig}
    slot="body"
  />
</BaseLayout>
